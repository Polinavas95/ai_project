Как устроен протокол HTTP и как формируются запросы
Когда вы загружаете веб-страницу или отправляете данные через форму, ваш компьютер общается с сервером. Но как именно происходит этот обмен?

На самом деле данные в компьютере — это просто последовательности байтов. А между устройствами эти байты передаются в виде сигналов — электрических, радиоволн, света и т. д. Чтобы такие передачи были возможны и согласованы, используется система уровней передачи данных, описанная в модели OSI (Open Systems Interconnection model).


Обмен данными между устройствами, при котором данные проходят все уровни от прикладного до физического и обратно
Обмен данными между устройствами, при котором данные проходят все уровни от прикладного до физического и обратно
Каждый уровень OSI определяет свои правила — протоколы, которые задают, как именно передавать информацию. Программы, с которыми мы работаем (браузеры, почтовые клиенты, API), используют прикладной уровень — самый верхний из семи. Это позволяет программисту не думать о низкоуровневой передаче сигналов, а просто выбрать нужный протокол и отправить запрос.

Один из самых распространённых протоколов прикладного уровня — HTTP (HyperText Transfer Protocol). Изначально он создавался для работы с HTML-документами, но сегодня используется для передачи любых типов данных: текстов, изображений, видео, документов.

HTTP устроен по принципу «запрос — ответ»:

клиент (например, браузер или программа) формирует запрос;
сервер принимает его и возвращает ответ с данными и кодом состояния.

Вступайте в сообщество хендбука
Здесь можно найти единомышленников, экспертов и просто интересных собеседников. А ещё — получить помощь или поделиться знаниями.
Коды состояния — это числа, по которым можно понять, как обработан запрос. Например:

200 — всё прошло успешно;
404 — объект не найден;
500 — ошибка на сервере.
Среди команд (методов) HTTP есть:

GET — получить данные;
POST — отправить данные;
PUT — создать или заменить ресурс;
DELETE — удалить ресурс.
HTTP-запросы широко применяются не только для загрузки веб-страниц. Многие современные сервисы возвращают по ним структурированные данные — например, список фильмов, прогноз погоды, изображение карты или результат поиска. Это возможно благодаря API (Application Programming Interface) — описаниям правил, по которым программы могут взаимодействовать друг с другом через HTTP.

API можно вызывать напрямую из браузера (через URL), но чаще всего для этого пишут программы на Python, JavaScript и других языках.

Далее мы разберём, как формировать такие запросы с помощью библиотеки requests, и вы научитесь получать полезные данные с внешних сервисов. Но сперва поговорим о том, что такое API.

Что такое API и зачем они нужны
Когда веб-сервису нужно передавать не веб-страницу, а данные — например, изображение, JSON-файл или координаты объекта, — он предоставляет API (Application Programming Interface). Это набор правил, по которым внешняя программа может отправить запрос и получить ответ. Обычно API работает поверх протокола HTTP — и поддерживает те же принципы: «запрос — ответ».

Один из примеров такого интерфейса — Static API Яндекс Карт. С его помощью можно получить изображение карты по заданным координатам, настроить масштаб, тип отображения (схема, спутник), добавить метки и включить пробки. Такой API особенно удобен, когда нужна актуальная карта, а не заранее загруженное изображение.

Простой пример запроса, который можно открыть прямо в браузере:

https://static-maps.yandex.ru/1.x/?ll=37.677751,55.757718&spn=0.016457,0.00619&l=map
В этом URL:

ll — координаты центра карты (долгота и широта);
spn — размер области показа;
l — тип карты (map, sat и др.).
Обратите внимание: в бесплатной версии Static API изображение карты должно быть размещено в открытом доступе — на сайте или в приложении. Также есть и другие ограничения, с которыми важно ознакомиться до начала работы.

А теперь потренируемся отправлять запросы с помощью библиотеки requests.

Как отправлять HTTP-запросы с помощью библиотеки requests
Чтобы получить данные от API в своей программе, нужно отправить HTTP-запрос и обработать HTTP-ответ. Сделать это удобно с помощью популярной библиотеки Python — requests.

Библиотека не входит в стандартную поставку Python, поэтому перед началом работы установите её с помощью команды:

pip install `requests`
В requests используются функции с теми же названиями, что и HTTP-запросы: get(), post(), put() и другие.
Рассмотрим пример GET-запроса к Static API Яндекс Карт:

from requests import get

response = get("https://static-maps.yandex.ru/1.x/?"
               "ll=37.677751,55.757718&"
               "spn=0.016457,0.00619&"
               "l=map")
print(response)

# Вывод программы

# <Response [200]>
Код ответа 200 означает, что запрос был успешно обработан сервером. Теперь можно извлечь полученные данные. Они находятся в атрибуте .content и представлены в виде последовательности байтов — это изображение карты в формате PNG.

Запишем его в файл:

with open("map.png", "wb") as file:
    file.write(response.content)
Файл map.png будет создан в той же папке, где находится программа. В нём окажется изображение нужного участка карты, сгенерированное сервером по указанным координатам и параметрам.

Как получать и сохранять данные, возвращаемые API
Ранее мы формировали HTTP-запрос как одну длинную строку. Однако у функции get() есть удобный именованный аргумент params, в который можно передать словарь параметров, — это делает код чище и понятнее:

params = {
    "ll": "37.677751,55.757718",
    "spn": "0.016457,0.00619",
    "l": "map"
}
response = get("<https://static-maps.yandex.ru/1.x/>", params=params)
При работе с API важно предусматривать обработку нештатных ситуаций, например отсутствие подключения к интернету. Если Сеть недоступна, requests выбросит исключение ConnectionError. Чтобы программа не завершалась с ошибкой, обернём запрос в конструкцию try–except:

from requests import get, ConnectionError

params = {
    "ll": "37.677751,55.757718",
    "spn": "0.016457,0.00619",
    "l": "map"
}

try:
    response = get("<https://static-maps.yandex.ru/1.x/>", params=params)
except ConnectionError:
    print("Проверьте подключение к Сети.")
else:
    with open("map.png", "wb") as file:
        file.write(response.content)
Если запрос прошёл успешно, карта будет сохранена в файл map.png в виде PNG-изображения.

На заметку: Static API Яндекс Карт поддерживает гораздо больше параметров — их список и примеры использования доступны в официальной документации.

Как работать с авторизацией через OAuth и API Яндекс Диска
Рассмотрим ещё один пример взаимодействия с API — на этот раз с облачным хранилищем Яндекс Диск. Он позволяет сохранять файлы, получать информацию о доступном месте и управлять содержимым хранилища. API Яндекс Диска подробно описан в официальной документации.

Авторизация по OAuth 2.0
Для доступа к данным пользователя необходима авторизация по протоколу OAuth 2.0. Это безопасный способ получить доступ к файлам, не запрашивая логин и пароль. Вместо этого используется токен авторизации — уникальная строка-ключ, которую необходимо добавлять к каждому запросу.

Чтобы получить токен, нужно:

Зарегистрировать приложение на странице создания клиента OAuth.
Указать:
название сервиса;
платформу «Веб-сервисы»;
тип URL — «Подставить URL для разработки»;
доступ к «Яндекс Диск REST API» со всеми четырьмя правами.
После регистрации приложения вы получите учётные данные клиента: ClientID, Client secret, Redirect URL. Они используются для аутентификации и авторизации вашего приложения при работе с API по протоколу OAuth 2.0.
Эти данные понадобятся для получения токена через библиотеку requests-oauthlib.

Пример авторизации

from requests_oauthlib import OAuth2Session
from requests import get, post, put, delete

client_id = ""
client_secret = ""
auth_url = "<https://oauth.yandex.ru/authorize>"
token_url = "<https://oauth.yandex.ru/token>"

oauth = OAuth2Session(client_id=client_id)
authorization_url, state = oauth.authorization_url(auth_url, force_confirm="true")
print("Перейдите по ссылке и авторизуйтесь:", authorization_url)

code = input("Введите одноразовый код: ")

token = oauth.fetch_token(
    token_url=token_url,
    code=code,
    client_secret=client_secret
)

access_token = token["access_token"]
print(access_token)
Полученный токен нужно добавлять к каждому запросу через заголовок Authorization.

headers = {"Authorization": f"OAuth {access_token}"}
Как получить информацию о диске
Для получения базовой информации (объём, свободное место, ограничения) используйте GET-запрос:

r = get("<https://cloud-api.yandex.net/v1/disk>", headers=headers)
print(r.json())
Ответ будет в формате JSON. Его можно обработать как словарь Python.

Как создать папку на диске
Создадим новую папку под названием Тест API:

params = {"path": "Тест API"}
r = put("<https://cloud-api.yandex.net/v1/disk/resources>", headers=headers, params=params)
print(r)
Если всё прошло успешно, вы увидите: <Response [201]>. Папка появится в корне диска.

dir
Как загрузить файл в облако
Чтобы загрузить файл map.png на Яндекс Диск с помощью API, выполните следующие шаги:

Получите временную ссылку для загрузки файла.
Отправьте файл по этой ссылке.
Убедитесь, что файл успешно загружен.
Шаг 1. Получите временную ссылку
Сначала нужно запросить URL, по которому вы сможете загрузить файл:

params = {"path": "Тест API/map.png"}
r = get("<https://cloud-api.yandex.net/v1/disk/resources/upload>", headers=headers, params=params)
href = r.json()["href"]
Шаг 2. Отправьте файл по этой ссылке
Теперь загрузите файл map.png с помощью метода PUT:

files = {"file": open("map.png", "rb")}
r = put(href, files=files)
print(r)
Шаг 3. Проверьте результат
Если файл успешно загружен, вы увидите в выводе:

Результат: <Response [201]>. Файл будет загружен в облако.

file
Теперь файл доступен в вашем Яндекс Диске по пути Тест API/map.png.

Что ещё можно сделать
Полный список возможностей API Яндекс Диска доступен по ссылке. Вы можете:

удалять и перемещать файлы;
публиковать ссылки;
отслеживать изменения в хранилище;
организовывать структуру папок.